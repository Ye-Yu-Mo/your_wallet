# YourWallet 开发流程文档

## 项目概览

YourWallet是一款基于Flutter + Rust技术栈的现代化记账应用。以简洁优雅的界面设计为核心，提供全面的财务管理功能，包括日常收支记录、投资组合管理、以及独特的双人协作记账功能。支持传统资产和加密货币投资追踪。

## 开发环境搭建

### 前端环境（Flutter）

1. **安装Flutter SDK**
   ```bash
   # 下载Flutter SDK
   git clone https://github.com/flutter/flutter.git
   export PATH="$PATH:`pwd`/flutter/bin"
   
   # 验证安装
   flutter doctor
   ```

2. **IDE配置**
   - 推荐使用VS Code + Flutter插件
   - 或Android Studio + Flutter插件

3. **依赖管理**
   ```bash
   cd frontend
   flutter pub get
   ```

### 后端环境（Rust）

1. **安装Rust工具链**
   ```bash
   # 安装rustup
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   
   # 更新工具链
   rustup update
   ```

2. **数据库安装**
   ```bash
   # PostgreSQL
   brew install postgresql
   brew services start postgresql
   
   # Redis
   brew install redis
   brew services start redis
   ```

3. **依赖管理**
   ```bash
   cd backend
   cargo build
   ```

## 开发工作流

### 1. 功能开发流程

```mermaid
graph LR
    A[创建功能分支] --> B[编写代码]
    B --> C[本地测试]
    C --> D[代码审查]
    D --> E[合并主分支]
    E --> F[部署测试]
```

### 2. 分支管理策略

- **main**: 主分支，只包含稳定版本
- **develop**: 开发分支，集成最新功能
- **feature/xxx**: 功能分支，开发具体功能
- **hotfix/xxx**: 紧急修复分支

### 3. 提交规范

使用约定式提交（Conventional Commits）：

```
<类型>(<范围>): <描述>

[可选的正文]

[可选的脚注]
```

**类型说明**：
- `feat`: 新功能
- `fix`: bug修复
- `docs`: 文档更新
- `style`: 代码格式化
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 其他杂项

**示例**：
```bash
git commit -m "feat(auth): add user login functionality"
git commit -m "fix(api): resolve transaction sync issue"
git commit -m "docs: update README with new installation steps"
```

## 开发阶段规划

### ✅ 已完成阶段：前后端API集成和数据交互

**项目基础设施完成情况**
- [x] **项目结构初始化**：Flutter前端和Rust后端完整框架
- [x] **后端API架构**：Axum Web框架，完整的RESTful API设计
- [x] **数据模型设计**：User、Account、Transaction、Category完整模型
- [x] **API端点实现**：15个核心业务端点全部实现
- [x] **依赖管理**：rust_decimal等关键依赖已配置
- [x] **服务运行测试**：HTTP服务器成功运行在3000端口
- [x] **跨域支持**：CORS配置完成，支持前端调用
- [x] **统一响应格式**：ApiResponse包装器，标准化JSON响应
- [x] **错误处理架构**：ServiceError枚举，分类错误处理

**前后端集成完成情况**
- [x] **HTTP客户端配置**：Dio集成完成，支持请求/响应拦截
- [x] **API服务封装**：AccountService等业务服务完整实现
- [x] **JSON序列化**：所有数据模型支持JSON转换
- [x] **类型转换处理**：解决后端字符串数字到前端double类型转换
- [x] **状态管理集成**：Provider状态管理，实时数据更新
- [x] **错误处理**：统一异常处理和用户提示
- [x] **API测试界面**：内置连接测试和状态监控
- [x] **数据流验证**：前后端数据交互完全测试通过

**当前服务状态**
- 🟢 **后端API服务**：http://127.0.0.1:3000 完全可用
- 🟢 **健康检查**：GET /health 正常响应
- 🟢 **业务端点**：用户、账户、交易、统计API全部测试通过
- 🟢 **前端应用**：Flutter在Android和Web平台运行正常
- 🟢 **数据集成**：前端成功加载和显示后端API数据
- 🟢 **实时更新**：Provider状态管理支持数据实时刷新

### Phase 1: 数据集成与业务完善（当前阶段，2-3周）

**第1周：前后端数据打通** ✅ **已完成**
- [x] 前端HTTP客户端配置（Dio集成）
- [x] API服务调用封装和错误处理
- [x] 真实数据替换模拟数据
- [x] 用户状态管理实现（Provider）
- [x] JSON序列化和类型转换修复
- [x] API测试界面和连接状态监控

**第2周：核心CRUD功能**
- [ ] 交易记录增删改查完整实现
- [ ] 账户管理功能完善
- [ ] 本地数据缓存策略
- [ ] 离线数据支持

**第3周：数据持久化**
- [ ] PostgreSQL数据库集成
- [ ] SeaORM实体和数据库操作
- [ ] 数据库迁移脚本
- [ ] Redis缓存层实现

### Phase 2: 功能完善与用户体验（3-4周）

**第4周：用户认证与安全**
- [ ] JWT认证系统实现
- [ ] 用户注册登录功能
- [ ] 密码加密和验证
- [ ] 会话管理和权限控制

**第5周：数据可视化**
- [ ] FL Chart图表库集成
- [ ] 收支趋势图表实现
- [ ] 投资组合饼图和折线图
- [ ] 月度和年度统计报表

**第6周：高级功能**
- [ ] 双人记账配对系统
- [ ] 实时数据同步（WebSocket）
- [ ] 交易凭证图片上传
- [ ] 数据导出（Excel/PDF）

**第7周：性能优化**
- [ ] 图片压缩和优化
- [ ] 列表虚拟化性能优化
- [ ] API响应缓存策略
- [ ] 离线数据支持完善

### Phase 3: 外部集成与扩展（2-3周）

**第8周：外部服务集成**
- [ ] 汇率API集成（实时汇率）
- [ ] 加密货币价格API（可选）
- [ ] 邮件服务（验证和通知）
- [ ] 推送通知服务

**第9周：测试完善**
- [ ] 单元测试覆盖率达到80%+
- [ ] 集成测试完整覆盖
- [ ] UI/UX测试和优化
- [ ] 性能压力测试

**第10周：发布准备**
- [ ] 应用图标和启动页
- [ ] 应用商店素材准备
- [ ] 用户手册和帮助文档
- [ ] 版本发布和分发

## 代码规范

### Flutter代码规范

1. **目录结构**
   ```
   lib/
   ├── main.dart
   ├── app/                 # 应用配置
   ├── models/             # 数据模型
   ├── services/           # 业务服务
   ├── screens/            # 页面
   ├── widgets/            # 组件
   ├── utils/              # 工具函数
   └── constants/          # 常量
   ```

2. **命名规范**
   - 文件名：使用下划线命名法（snake_case）
   - 类名：使用大驼峰命名法（PascalCase）
   - 变量和函数：使用小驼峰命名法（camelCase）

3. **状态管理**
   - 使用Provider或Riverpod进行状态管理
   - 避免使用全局变量
   - 合理拆分状态管理颗粒度

### Rust代码规范

1. **项目结构**
   ```
   src/
   ├── main.rs
   ├── lib.rs
   ├── api/                # API处理器
   ├── models/             # 数据模型
   ├── services/           # 业务逻辑
   ├── db/                 # 数据库操作
   └── utils/              # 工具函数
   ```

2. **命名规范**
   - 使用snake_case命名函数和变量
   - 使用PascalCase命名结构体和枚举
   - 使用SCREAMING_SNAKE_CASE命名常量

3. **错误处理**
   - 使用Result<T, E>处理可能失败的操作
   - 合理使用?操作符进行错误传播
   - 定义清晰的错误类型

## 测试策略

### 前端测试
- **单元测试**：测试工具函数和业务逻辑
- **组件测试**：测试UI组件的行为
- **集成测试**：测试页面间的交互
- **端到端测试**：测试完整的用户流程

### 后端测试
- **单元测试**：测试函数和模块
- **集成测试**：测试API端点
- **数据库测试**：测试数据操作
- **性能测试**：测试接口响应时间

## 部署流程

### 开发环境
- 本地开发服务器
- 使用Docker Compose启动依赖服务
- 热重载开发模式

### 测试环境
- CI/CD自动部署
- 集成测试自动化
- 性能监控

### 生产环境
- 蓝绿部署策略
- 数据库迁移脚本
- 监控和日志收集

## 当前开发工作流

### 快速启动开发环境
```bash
# 启动完整开发环境（一键启动脚本）
./start-dev.sh

# 或分别启动各服务：

# 1. 启动后端API服务
cd backend && cargo run
# ✅ 服务运行在 http://127.0.0.1:3000

# 2. 启动前端（Chrome Web版）
cd frontend && flutter run -d chrome
# ✅ Web应用运行在 http://localhost:xxxx

# 3. 启动前端（Android模拟器）
cd frontend && flutter run -d emulator-5554
# ✅ Android应用运行在模拟器
```

### 当前开发环境状态
- 🟢 **后端API**: http://127.0.0.1:3000（完全可用）
- 🟢 **前端Web**: Chrome浏览器（热重载开发）
- 🟢 **前端Android**: 模拟器（热重载开发）
- 🟢 **API测试**: 所有端点测试通过

### 常用开发命令

**Flutter命令**
```bash
# 运行应用（自动选择设备）
flutter run

# 运行在特定设备
flutter run -d chrome          # Web版本
flutter run -d emulator-5554   # Android模拟器

# 构建应用
flutter build apk             # Android APK
flutter build web             # Web版本

# 开发工具
flutter test                  # 运行测试
flutter analyze              # 代码分析
flutter pub get              # 获取依赖
flutter doctor               # 环境检查
```

**Rust后端命令**
```bash
# 开发环境运行
cargo run

# 生产环境构建
cargo build --release

# 代码质量
cargo test                    # 运行测试
cargo clippy                  # 代码检查
cargo fmt                     # 代码格式化

# 依赖管理
cargo check                   # 快速检查
cargo update                  # 更新依赖
```

### 数据库命令
```bash
# 运行迁移
sqlx migrate run

# 创建迁移文件
sqlx migrate add <migration_name>

# 重置数据库
sqlx database reset
```

## API接口测试

### 可用端点清单
所有端点均已实现并测试通过：

**基础端点**
```bash
# 健康检查
curl http://127.0.0.1:3000/health
curl http://127.0.0.1:3000/

# 业务API测试
curl http://127.0.0.1:3000/api/accounts
curl http://127.0.0.1:3000/api/transactions
curl http://127.0.0.1:3000/api/categories
curl http://127.0.0.1:3000/api/summary
```

**完整API端点列表**
- `GET /` - 欢迎信息
- `GET /health` - 健康检查
- `POST /api/users` - 创建用户
- `GET /api/users/:id` - 获取用户信息
- `GET /api/accounts` - 获取账户列表
- `POST /api/accounts` - 创建新账户
- `GET /api/accounts/:id` - 获取特定账户
- `PUT /api/accounts/:id` - 更新账户
- `DELETE /api/accounts/:id` - 删除账户
- `GET /api/transactions` - 获取交易列表
- `POST /api/transactions` - 创建新交易
- `GET /api/transactions/:id` - 获取特定交易
- `PUT /api/transactions/:id` - 更新交易
- `DELETE /api/transactions/:id` - 删除交易
- `GET /api/categories` - 获取交易分类
- `GET /api/summary` - 获取财务概览

## 问题排查

### ✅ 已解决问题
1. **模块冲突错误** 
   - 问题：backend/src存在同名.rs文件和目录
   - 解决：删除冲突的模块目录
   
2. **rust_decimal依赖缺失**
   - 问题：编译时找不到rust_decimal模块
   - 解决：在Cargo.toml中添加rust_decimal依赖

3. **端口占用问题**
   - 问题：3000端口被其他进程占用
   - 解决：使用lsof命令终止占用进程

4. **API响应类型转换错误** ⭐ **最新解决**
   - 问题：后端返回数字字符串（"5000"），前端期望double类型
   - 解决：添加_stringToDouble辅助函数，使用@JsonKey(fromJson: _stringToDouble)
   - 影响：Account.balance、FinancialSummary.totalIncome等字段

5. **前端编译错误**
   - 问题：API测试屏幕访问PaginatedResponse.length错误
   - 解决：修正为PaginatedResponse.data.length
   - 结果：前端成功显示"✅ Loaded 2 accounts"

### 常见开发问题
1. **Flutter热重载失败**
   - 检查语法错误
   - 使用 `r` 热重载或 `R` 完全重启
   - 检查是否有编译错误

2. **Rust编译错误**
   - 运行 `cargo clean` 清理缓存
   - 检查依赖版本兼容性
   - 查看编译日志定位具体错误

3. **跨域问题**
   - 已配置CORS支持
   - 确认前端请求地址正确
   - 检查浏览器控制台错误

### 调试技巧
- 后端：使用 `tracing` 日志查看请求响应
- 前端：使用Flutter DevTools调试
- API：使用curl或Postman测试接口
- 网络：使用浏览器开发者工具查看请求

## 团队协作

### 代码审查
- 每个PR至少需要一人审查
- 关注代码质量和规范
- 测试覆盖率要求

### 文档维护
- 及时更新API文档
- 维护变更日志
- 更新用户手册

### 沟通协作
- 使用Issue跟踪问题和需求
- 定期团队会议同步进度
- 知识分享和技术讨论

---

## 📊 项目当前状态总览

### 🟢 已完成核心组件
- **后端API服务**：100%完成，15个端点全部可用
- **前端UI框架**：100%完成，4个主要页面实现
- **跨平台支持**：Android和Web平台完全可用
- **开发环境**：一键启动脚本，热重载开发

### 🔄 当前开发重点
1. **前后端数据打通**：API集成，真实数据替换
2. **业务逻辑完善**：CRUD操作，状态管理
3. **数据持久化**：PostgreSQL集成，缓存策略

### 📈 下阶段目标
- Week 1: 实现前后端完整数据流
- Week 2: 核心功能完善和测试
- Week 3: 数据库集成和性能优化

**最后更新**: 2025-09-07  
**项目状态**: 🟢 后端API完成，进入数据集成阶段